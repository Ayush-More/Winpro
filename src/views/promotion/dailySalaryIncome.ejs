<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="/logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Salary Income - DeltInWin</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <link rel="stylesheet" crossorigin href="/index_files/index-BUBUniRp.css">
</head>

<body style="font-size: 12px;">
  <div id="root">
    <div class="mainApp">
      <div class="container-fluid" style="padding: 4px 12px;">
        <!-- Header -->
        <div class="row align-items-center mb-3">
          <div class="col-2">
            <a href="/promotion" class="text-decoration-none">
              <i class="fa-solid fa-arrow-left text-theme1" style="font-size: 20px;"></i>
            </a>
          </div>
          <div class="col-8 text-center">
            <h5 class="mb-0 text-theme1 fw-bold">Daily Salary Income</h5>
          </div>
          <div class="col-2"></div>
        </div>

        <!-- Income Summary -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="card bg-gradient-primary text-white border-0 rounded-3">
              <div class="card-body" style="background: linear-gradient(90deg, #E67302 0%, #ee0a24 100%);">
                <div class="row text-center">
                  <div class="col-4">
                    <h6 class="card-title mb-1">Today</h6>
                    <h4 class="mb-0" id="today-income">₹0.00</h4>
                  </div>
                  <div class="col-4">
                    <h6 class="card-title mb-1">This Month</h6>
                    <h4 class="mb-0" id="month-income">₹0.00</h4>
                  </div>
                  <div class="col-4">
                    <h6 class="card-title mb-1">Total</h6>
                    <h4 class="mb-0" id="total-income">₹0.00</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Level Status -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="card border-0 rounded-3 bg-light">
              <div class="card-body">
                <h6 class="card-title text-theme1 mb-3">
                  <i class="fa-solid fa-trophy me-2"></i>Current Level Status
                </h6>
                <div class="row">
                  <div class="col-6">
                    <small class="text-muted">Current Level</small>
                    <div class="fw-bold text-primary" id="current-level">Level 0</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Daily Income</small>
                    <div class="fw-bold text-success" id="daily-income-rate">₹0</div>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-6">
                    <small class="text-muted">Active Players</small>
                    <div class="fw-bold" id="active-players">0</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Total Recharge</small>
                    <div class="fw-bold" id="total-recharge">₹0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Next Level Requirements -->
        <div class="row mb-3" id="next-level-card" style="display: none;">
          <div class="col-12">
            <div class="card border-0 rounded-3" style="border-left: 4px solid #007bff !important;">
              <div class="card-body">
                <h6 class="card-title text-primary mb-3">
                  <i class="fa-solid fa-arrow-up me-2"></i>Next Level Requirements
                </h6>
                <div class="row">
                  <div class="col-6">
                    <small class="text-muted">Need Active Players</small>
                    <div class="fw-bold" id="need-players">0</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Need Total Recharge</small>
                    <div class="fw-bold" id="need-recharge">₹0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Income History -->
        <div class="row">
          <div class="col-12">
            <div class="card border-0 rounded-3">
              <div class="card-header bg-theme1 text-white">
                <h6 class="mb-0">Income History</h6>
              </div>
              <div class="card-body p-0">
                <div id="income-list" class="list-group list-group-flush">
                  <!-- Loading state -->
                  <div class="list-group-item text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Loading income data...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Salary Levels Table -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card border-0 rounded-3">
              <div class="card-header bg-theme1 text-white">
                <h6 class="mb-0">Daily Salary Levels</h6>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Level</th>
                        <th>Active Players</th>
                        <th>Min Recharge</th>
                        <th>Daily Income</th>
                      </tr>
                    </thead>
                    <tbody id="salary-levels-table">
                      <!-- Will be populated dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div class="van-overlay" style="z-index: 2000; display: none;">
        <div class="Loading">
          <div class="van-loading van-loading--spinner van-loading--vertical">
            <span class="van-loading__spinner van-loading__spinner--spinner" style="width: 30px; height: 30px;">
              <svg viewBox="25 25 50 50" class="circular">
                <circle cx="50" cy="50" r="20" fill="none" class="path"></circle>
              </svg>
            </span>
            <span class="van-loading__text">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/client.js"></script>

  <script>
    $(document).ready(() => {
      loadIncomeData();
    });

    function loadIncomeData() {
      $('.van-overlay').fadeIn(10);

      $.ajax({
        url: '/api/webapi/DailySalary',
        method: 'POST',
        success: function(response) {
          if (response && response.status && response.data) {
            updateIncomeUI(response.data);
          } else {
            renderIncomeHistory([]);
          }
        },
        error: function() {
          renderIncomeHistory([]);
        },
        complete: function() {
          $('.van-overlay').fadeOut(200);
        }
      });
    }

    function updateIncomeUI(data) {
      const { currentLevel, totalSalaryEarned, activePlayers, totalRecharge, salaryLevels, nextLevelRequirement, todayEarned, monthEarned } = data;

      const current = salaryLevels.find(l => l.level === currentLevel) || { dailyIncome: 0 };
      const dailyIncome = current.dailyIncome || 0;

      // Use actual earned amounts if available, otherwise fallback to calculated values
      const todayAmount = todayEarned !== undefined ? todayEarned : dailyIncome;
      const monthAmount = monthEarned !== undefined ? monthEarned : (dailyIncome * 30);

      $('#today-income').text(`₹${todayAmount.toLocaleString()}`);
      $('#month-income').text(`₹${monthAmount.toLocaleString()}`);
      $('#total-income').text(`₹${totalSalaryEarned.toLocaleString()}`);
      $('#current-level').text(`Level ${currentLevel}`);
      $('#daily-income-rate').text(`₹${dailyIncome.toLocaleString()}`);
      
      // Add visual indicator for Level 0
      if (currentLevel === 0) {
        $('#daily-income-rate').addClass('text-muted').text('₹0 (Not Qualified)');
      } else {
        $('#daily-income-rate').removeClass('text-muted').text(`₹${dailyIncome.toLocaleString()}`);
      }
      $('#active-players').text(activePlayers);
      $('#total-recharge').text(`₹${totalRecharge.toLocaleString()}`);

      if (nextLevelRequirement && currentLevel < 10) {
        $('#next-level-card').show();
        $('#need-players').text(nextLevelRequirement.players);
        $('#need-recharge').text(`₹${nextLevelRequirement.recharge.toLocaleString()}`);
      } else {
        $('#next-level-card').hide();
      }

      renderSalaryLevelsTable(salaryLevels, currentLevel);
      renderIncomeHistory(data.records);
    }

    function renderSalaryLevelsTable(salaryLevels, currentLevel) {
      const table = $('#salary-levels-table').empty();

      salaryLevels.forEach(level => {
        const highlight = level.level === currentLevel ? 'table-primary' : '';
        const badge = level.level === currentLevel ? '<span class="badge bg-primary ms-2">Current</span>' : '';
        const incomeClass = level.level === 0 ? 'text-muted' : 'text-success fw-bold';
        const incomeText = level.level === 0 ? '₹0 (Not Qualified)' : `₹${level.dailyIncome.toLocaleString()}`;

        table.append(`
          <tr class="${highlight}">
            <td><strong>Level ${level.level}</strong>${badge}</td>
            <td>${level.players}</td>
            <td>₹${level.recharge.toLocaleString()}</td>
            <td class="${incomeClass}">${incomeText}</td>
          </tr>
        `);
      });
    }

    function renderIncomeHistory(history) {
      const list = $('#income-list').empty();

      if (!history || !history.length) {
        list.html(`
          <div class="list-group-item text-center py-4">
            <i class="fa-solid fa-chart-line text-muted" style="font-size: 48px;"></i>
            <p class="mt-2 mb-0 text-muted">No daily salary history found</p>
            <small class="text-muted">Daily salary will appear once you qualify</small>
          </div>
        `);
        return;
      }

      history.forEach(record => {
        const date = new Date(record.date_time).toLocaleDateString();
        const amount = parseFloat(record.amount || 0);
        const level = record.level || 0;
        const players = record.active_players || 0;

        list.append(`
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">Daily Salary - Level ${level}</h6>
                <p class="mb-1 text-muted small">
                  <i class="fa-solid fa-users me-1"></i>${players} Active Players
                </p>
                <small class="text-muted">${date}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-success">+₹${amount.toLocaleString()}</span>
              </div>
            </div>
          </div>
        `);
      });
    }
  </script>
</body>
</html>
