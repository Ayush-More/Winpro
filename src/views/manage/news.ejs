<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News Management</title>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback" />
  <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet" />
  <link rel="stylesheet" href="/dist/css/adminlte.min.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <style>
    .block-click {
      pointer-events: none;
    }
    .news-type-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .news-type-urgent {
      background-color: #dc3545;
      color: white;
    }
    .news-type-announcement {
      background-color: #ffc107;
      color: black;
    }
    .news-type-update {
      background-color: #28a745;
      color: white;
    }
    .news-content-preview {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>

<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <%- include('nav') %>
      <div class="content-wrapper">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1>News Management</h1>
              </div>
              <div class="col-sm-6">
                <button type="button" class="btn btn-primary float-right" data-toggle="modal" data-target="#addNewsModal">
                  <i class="fas fa-plus"></i> Add News
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Main content -->
        <section class="content">
          <!-- Default box -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">News List</h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-0" style="overflow-y: hidden">
              <table class="table table-striped projects" id="newsTable">
                <thead>
                  <tr>
                    <th class="text-center">#</th>
                    <th class="text-center">Title</th>
                    <th class="text-center">Type</th>
                    <th class="text-center">Content Preview</th>
                    <th class="text-center">Views</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Created</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- News items will be loaded here -->
                </tbody>
              </table>
            </div>
            <nav aria-label="Page navigation example" style="margin-top: 20px; display: flex; justify-content: center">
                <ul class="pagination newsTable">
                    <li class="page-item previous" id="previous">
                        <a class="page-link" href="#" tabindex="-1">Previous</a>
                    </li>
                    <div id="numbers" style="display: flex">
                        <li class="page-item">
                            <a class="page-link active text-white" id="text-page"></a>
                        </li>
                    </div>
                    <li class="page-item next" id="next">
                        <a class="page-link" href="#">Next</a>
                    </li>
                </ul>
            </nav>
          </div>
        </section>
      </div>
  </div>

  <!-- Add News Modal -->
  <div class="modal fade" id="addNewsModal" tabindex="-1" role="dialog" aria-labelledby="addNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addNewsModalLabel">Add News</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="addNewsForm">
            <div class="form-group">
              <label for="newsTitle">Title</label>
              <input type="text" class="form-control" id="newsTitle" name="title" required>
            </div>
            <div class="form-group">
              <label for="newsType">Type</label>
              <select class="form-control" id="newsType" name="type" required>
                <option value="announcement">Announcement</option>
                <option value="urgent">Urgent</option>
                <option value="update">Update</option>
              </select>
            </div>
            <div class="form-group">
              <label for="newsContent">Content</label>
              <textarea class="form-control" id="newsContent" name="content" rows="6" required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveNews()">Save News</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit News Modal -->
  <div class="modal fade" id="editNewsModal" tabindex="-1" role="dialog" aria-labelledby="editNewsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editNewsModalLabel">Edit News</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="editNewsForm">
            <input type="hidden" id="editNewsId" name="id">
            <div class="form-group">
              <label for="editNewsTitle">Title</label>
              <input type="text" class="form-control" id="editNewsTitle" name="title" required>
            </div>
            <div class="form-group">
              <label for="editNewsType">Type</label>
              <select class="form-control" id="editNewsType" name="type" required>
                <option value="announcement">Announcement</option>
                <option value="urgent">Urgent</option>
                <option value="update">Update</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editNewsStatus">Status</label>
              <select class="form-control" id="editNewsStatus" name="status" required>
                <option value="1">Active</option>
                <option value="0">Inactive</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editNewsContent">Content</label>
              <textarea class="form-control" id="editNewsContent" name="content" rows="6" required></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="updateNews()">Update News</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/plugins/jquery/jquery.min.js"></script>
  <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/dist/js/adminlte.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
  <script src="/js/admin/admin.js"></script>

  <script>
    let currentPage = 0;
    let limit = 10;
    let totalPages = 0;

    $(document).ready(function() {
      loadNews();
      setupPagination();
    });

    function loadNews() {
      $.ajax({
        type: "POST",
        url: "/api/webapi/admin/news/list",
        data: {
          pageno: currentPage,
          limit: limit
        },
        dataType: "json",
        success: function(response) {
          if (response.status === true) {
            renderNewsTable(response.datas);
            totalPages = response.page_total;
            updatePagination();
          } else {
            Swal.fire('Error', 'Failed to load news', 'error');
          }
        },
        error: function() {
          Swal.fire('Error', 'Failed to load news', 'error');
        }
      });
    }

    function renderNewsTable(newsData) {
      let tbody = $('#newsTable tbody');
      tbody.empty();

      if (newsData.length === 0) {
        tbody.append('<tr><td colspan="8" class="text-center">No news found</td></tr>');
        return;
      }

      newsData.forEach((news, index) => {
        let statusBadge = news.status == 1 ?
          '<span class="badge badge-success">Active</span>' :
          '<span class="badge badge-danger">Inactive</span>';

        let typeBadge = `<span class="news-type-badge news-type-${news.type}">${news.type.toUpperCase()}</span>`;

        let contentPreview = news.content.length > 50 ?
          news.content.substring(0, 50) + '...' :
          news.content;

        let createdDate = new Date(news.created_at).toLocaleDateString();

        let row = `
          <tr>
            <td class="text-center">${currentPage * limit + index + 1}</td>
            <td class="text-center">${news.title}</td>
            <td class="text-center">${typeBadge}</td>
            <td class="text-center news-content-preview">${contentPreview}</td>
            <td class="text-center">${news.views}</td>
            <td class="text-center">${statusBadge}</td>
            <td class="text-center">${createdDate}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-info" onclick="editNews(${news.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteNews(${news.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
        tbody.append(row);
      });
    }

    function setupPagination() {
      $('.newsTable .previous').click(function(e) {
        e.preventDefault();
        if (currentPage > 0) {
          currentPage--;
          loadNews();
        }
      });

      $('.newsTable .next').click(function(e) {
        e.preventDefault();
        if (currentPage < totalPages - 1) {
          currentPage++;
          loadNews();
        }
      });
    }

    function updatePagination() {
      $('#text-page').text(`Page ${currentPage + 1} of ${totalPages}`);

      if (currentPage === 0) {
        $('.newsTable .previous').addClass('disabled');
      } else {
        $('.newsTable .previous').removeClass('disabled');
      }

      if (currentPage >= totalPages - 1) {
        $('.newsTable .next').addClass('disabled');
      } else {
        $('.newsTable .next').removeClass('disabled');
      }
    }

    function saveNews() {
      let formData = {
        title: $('#newsTitle').val(),
        content: $('#newsContent').val(),
        type: $('#newsType').val()
      };

      if (!formData.title || !formData.content || !formData.type) {
        Swal.fire('Error', 'Please fill all required fields', 'error');
        return;
      }

      $.ajax({
        type: "POST",
        url: "/api/webapi/admin/news/create",
        data: formData,
        dataType: "json",
        success: function(response) {
          if (response.status === true) {
            Swal.fire('Success', 'News created successfully', 'success');
            $('#addNewsModal').modal('hide');
            $('#addNewsForm')[0].reset();
            loadNews();
          } else {
            Swal.fire('Error', response.message || 'Failed to create news', 'error');
          }
        },
        error: function() {
          Swal.fire('Error', 'Failed to create news', 'error');
        }
      });
    }

    function editNews(id) {
      $.ajax({
        type: "GET",
        url: `/api/webapi/admin/news/${id}`,
        dataType: "json",
        success: function(response) {
          if (response.status === true) {
            let news = response.data;
            $('#editNewsId').val(news.id);
            $('#editNewsTitle').val(news.title);
            $('#editNewsContent').val(news.content);
            $('#editNewsType').val(news.type);
            $('#editNewsStatus').val(news.status);
            $('#editNewsModal').modal('show');
          } else {
            Swal.fire('Error', 'Failed to load news details', 'error');
          }
        },
        error: function() {
          Swal.fire('Error', 'Failed to load news details', 'error');
        }
      });
    }

    function updateNews() {
      let formData = {
        id: $('#editNewsId').val(),
        title: $('#editNewsTitle').val(),
        content: $('#editNewsContent').val(),
        type: $('#editNewsType').val(),
        status: $('#editNewsStatus').val()
      };

      if (!formData.title || !formData.content || !formData.type) {
        Swal.fire('Error', 'Please fill all required fields', 'error');
        return;
      }

      $.ajax({
        type: "POST",
        url: "/api/webapi/admin/news/update",
        data: formData,
        dataType: "json",
        success: function(response) {
          if (response.status === true) {
            Swal.fire('Success', 'News updated successfully', 'success');
            $('#editNewsModal').modal('hide');
            loadNews();
          } else {
            Swal.fire('Error', response.message || 'Failed to update news', 'error');
          }
        },
        error: function() {
          Swal.fire('Error', 'Failed to update news', 'error');
        }
      });
    }

    function deleteNews(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            type: "POST",
            url: "/api/webapi/admin/news/delete",
            data: { id: id },
            dataType: "json",
            success: function(response) {
              if (response.status === true) {
                Swal.fire('Deleted!', 'News has been deleted.', 'success');
                loadNews();
              } else {
                Swal.fire('Error', response.message || 'Failed to delete news', 'error');
              }
            },
            error: function() {
              Swal.fire('Error', 'Failed to delete news', 'error');
            }
          });
        }
      });
    }
  </script>
