<!DOCTYPE html>
<html lang="en">

<head>
   <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback" />
  <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet" />
  <link rel="stylesheet" href="/dist/css/adminlte.min.css" />

   
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        .table th {
            background-color: #495057;
            color: white;
            border: none;
        }
        .badge-success {
            background-color: #28a745;
        }
        .badge-danger {
            background-color: #dc3545;
        }
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
    </style>
</head>

<body class="hold-transition sidebar-mini">
     <div class="wrapper">
    <%- include('nav') %>
      <div class="content-wrapper">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>P2P Transfers Management
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6>Total Transfers</h6>
                                                <h4 id="totalTransfers">0</h4>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-exchange-alt fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6>Total Amount</h6>
                                                <h4 id="totalAmount">₹0</h4>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-rupee-sign fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6>Today's Transfers</h6>
                                                <h4 id="todayTransfers">0</h4>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-calendar-day fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <h6>Today's Amount</h6>
                                                <h4 id="todayAmount">₹0</h4>
                                            </div>
                                            <div class="align-self-center">
                                                <i class="fas fa-chart-line fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="searchSender" placeholder="Search sender phone...">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="searchReceiver" placeholder="Search receiver phone...">
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                            </div>
                        </div>

                        <!-- Transfers Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Sender</th>
                                        <th>Receiver</th>
                                        <th>Amount</th>
                                        <th>Transfer Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transfersTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Details Modal -->
    <div class="modal fade" id="transferDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transfer Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transferDetailsBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        const itemsPerPage = 20;

        $(document).ready(function() {
            loadTransfers();
        });

        function loadTransfers(page = 1) {
            currentPage = page;
            const offset = (page - 1) * itemsPerPage;

            $.ajax({
                url: '/api/webapi/admin/p2p-transfers/list',
                method: 'POST',
                data: {
                    pageno: offset,
                    limit: itemsPerPage
                },
                success: function(response) {
                    if (response.status) {
                        displayTransfers(response.datas);
                        updateStatistics(response.datas);
                        updatePagination(response.total);
                    } else {
                        showError('Failed to load transfers');
                    }
                },
                error: function() {
                    showError('Error loading transfers');
                }
            });
        }

        function displayTransfers(transfers) {
            const tbody = $('#transfersTableBody');
            tbody.empty();

            if (transfers.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="6" class="text-center">No transfers found</td>
                    </tr>
                `);
                return;
            }

            transfers.forEach(transfer => {
                tbody.append(`
                    <tr>
                        <td>${transfer.id}</td>
                        <td>
                            <div>
                                <strong>${transfer.sender_name || 'Unknown'}</strong><br>
                                <small class="text-muted">${transfer.sender_phone}</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                <strong>${transfer.receiver_name || 'Unknown'}</strong><br>
                                <small class="text-muted">${transfer.receiver_phone}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-success">₹${parseFloat(transfer.amount).toFixed(2)}</span>
                        </td>
                        <td>${transfer.transfer_time || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewTransferDetails(${transfer.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `);
            });
        }

        function updateStatistics(transfers) {
            const total = transfers.length;
            const totalAmount = transfers.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            const today = new Date().toISOString().split('T')[0];
            const todayTransfers = transfers.filter(t => t.transfer_time && t.transfer_time.startsWith(today));
            const todayAmount = todayTransfers.reduce((sum, t) => sum + parseFloat(t.amount), 0);

            $('#totalTransfers').text(total);
            $('#totalAmount').text(`₹${totalAmount.toFixed(2)}`);
            $('#todayTransfers').text(todayTransfers.length);
            $('#todayAmount').text(`₹${todayAmount.toFixed(2)}`);
        }

        function updatePagination(total) {
            totalPages = Math.ceil(total / itemsPerPage);
            const pagination = $('#pagination');
            pagination.empty();

            // Previous button
            pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadTransfers(${currentPage - 1})">Previous</a>
                </li>
            `);

            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadTransfers(${i})">${i}</a>
                    </li>
                `);
            }

            // Next button
            pagination.append(`
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadTransfers(${currentPage + 1})">Next</a>
                </li>
            `);
        }

        function viewTransferDetails(transferId) {
            // Implementation for viewing transfer details
            $('#transferDetailsBody').html(`
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `);
            $('#transferDetailsModal').modal('show');
            
            // Here you would load detailed transfer information
            setTimeout(() => {
                $('#transferDetailsBody').html(`
                    <p><strong>Transfer ID:</strong> ${transferId}</p>
                    <p><strong>Status:</strong> <span class="badge bg-success">Completed</span></p>
                    <p>Detailed transfer information would be displayed here.</p>
                `);
            }, 1000);
        }

        function refreshData() {
            loadTransfers(currentPage);
        }

        function applyFilters() {
            // Implementation for applying filters
            loadTransfers(1);
        }

        function showError(message) {
            alert(message); // Replace with better error handling
        }
    </script>
</body>
</html>
